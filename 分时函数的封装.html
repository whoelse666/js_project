<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>分时函数的封装</title>
</head>

<body>

  <button class='btn'>抽入300000个元素</button>
  <script>
    const tasks = Array.from({ length: 100000 }, (_, i) => () => {
      const div = document.createElement("div")
      div.innerText = i
      document.body.appendChild(div)
    })

    const btn = document.querySelector(".btn")
    btn.onclick = () => {
      // for (const task of tasks) {
      //   task();
      // }
      const sheduler = (runChunk) => {
        let count = 0
        setTimeout(() => {
          runChunk(() => count++ < 3)
        }, 1000)
      }
      performTask(tasks, sheduler)
      // idlePerformTask(tasks, )
    }

    function performTask(tasks, sheduler) {
      let index = 0
      function _run() {
        /*    requestIdleCallback(idle => {
             while (index < tasks.length && idle.timeRemaining() > 0) {
               tasks[index++]()
             }
             if (index < tasks.length) {
               _run()
             }
           }) */
        sheduler(isGoOn => {
          while (index < tasks.length && isGoOn()) {
            tasks[index++]()
          }
          if (index < tasks.length) {
            _run()
          }
        })
      }
      _run()
    }



    function idlePerformTask(tasks) {
      performTask(tasks, (runChunk) => {
        requestIdleCallback((idle) => {
          runChunk(() => idle.timeRemaining() > 0)
        })
      })
    };
  </script>
</body>

</html>